Document analysis sisteminde, knowledge base (KB) chunklarının user prompta dahil edilmesi için aşağıdaki adımları izleyin:

Her Doküman Chunku İçin Sorgu:
Analiz edilen dokümanın her bir chunku (örneğin, 24 chunkluk bir dokümanda D1, D2, ..., D24) için KB’ye ayrı bir sorgu atın.
En Benzer KB Chunkunun Seçimi:
Her sorguda, KB’de o doküman chunkuna en yüksek similarity score’a sahip KB chunkunu belirleyin (örneğin, K_j).
Chunk ve Komşularının Dahil Edilmesi:
Seçilen KB chunkunu (K_j) mutlaka ekleyin.
Ayrıca, bu chunkun aynı dokümandaki hemen önceki (K_{j-1}) ve sonraki (K_{j+1}) chunklarını da ekleyin, eğer bu chunklar mevcutsa. Örneğin:
Eğer K_j, document_id: 24, chunk_index: 1 ise, K_{j-1} (chunk_index: 0) ve K_{j+1} (chunk_index: 2) de document_id: 24’ten alınmalıdır.
K_j ilk chunk (chunk_index: 0) veya son chunk ise, yalnızca mevcut komşu chunk eklenir.
Tüm Doküman Chunkları İçin Tekrar:
Analiz edilen dokümanın tüm chunkları için bu işlemi tekrarlayın. Her chunk için en fazla 3 KB chunku (en benzer + komşuları) seçilecektir.
Duplicatelerin Kaldırılması:
Tüm seçilen KB chunklarını bir araya getirin ve fingerprint (fp) alanına göre duplicateleri kaldırın. Her KB chunku, unique fingerprint’i sayesinde yalnızca bir kez context’te yer almalıdır.
Son Context’in Oluşturulması:
Deduplicate edilmiş KB chunk listesini user promptun knowledge base context kısmına ekleyin. Her KB chunku şu bilgileri içermelidir:
document_name
document_id
chunk_index
similarity_score
content
meta_info
Önemli Notlar
En Benzer Chunkun Dahil Edilmesi: Her doküman chunku için en yüksek similarity score’a sahip KB chunku mutlaka context’e dahil edilmelidir. Mevcut sistemde bu chunk atlanıyor (örneğin, chunk_index: 1 eksik), bu hata düzeltilmelidir.
Kenar Durumlar: Eğer en benzer KB chunku dokümanın başında (chunk_index: 0) veya sonunda (örneğin, total_chunks - 1) ise, yalnızca mevcut komşu chunklar eklenir.
Fingerprint Kullanımı: Duplicatelerin kaldırılması için KB chunklarının fingerprint (fp) alanı kullanılmalıdır. Bu, aynı içeriğin birden fazla kez eklenmesini önler.
Örnek
24 chunkluk bir doküman analiz edildiğinde:

D1 için en benzer KB chunku: document_id: 24, chunk_index: 1, similarity_score: 0.9
Eklenenler: chunk_index 0, 1, 2 (document_id: 24)
D2 için en benzer KB chunku: document_id: 22, chunk_index: 10, similarity_score: 0.85
Eklenenler: chunk_index 9, 10, 11 (document_id: 22)
Tüm chunklar işlendikten sonra, fingerprint ile duplicateler kaldırılır ve toplam KB chunk sayısı (örneğin, 7) elde edilir.