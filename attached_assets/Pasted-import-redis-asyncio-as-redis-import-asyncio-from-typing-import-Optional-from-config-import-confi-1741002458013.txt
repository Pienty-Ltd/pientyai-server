import redis.asyncio as redis
import asyncio
from typing import Optional
from config import config

class RedisService:
    _client: Optional[redis.Redis] = None
    _lock = asyncio.Lock()

    def __init__(self):
        self.redis_url = config.REDIS_URL

    async def get_client(self) -> redis.Redis:
        async with self._lock:
            if self._client is None or self._client.closed:
                self._client = await redis.from_url(self.redis_url, decode_responses=True)
                try:
                    await asyncio.wait_for(self._client.ping(), timeout=5)
                except asyncio.TimeoutError:
                    await self._client.close()
                    raise Exception("Redis bağlantısı zaman aşımına uğradı!")
                except Exception as e:
                    await self._client.close()
                    raise Exception(f"Redis bağlantısı kurulamadı: {e}")
        return self._client

    async def set_value(self, key: str, value: str, expire: Optional[int] = None) -> None:
        """
        Belirtilen anahtar için değer atar.
        :param key: Anahtar adı
        :param value: Atanacak değer
        :param expire: (İsteğe bağlı) Süre sonu, saniye cinsinden
        """
        client = await self.get_client()
        await client.set(name=key, value=value, ex=expire)

    async def get_value(self, key: str) -> Optional[str]:
        """
        Belirtilen anahtara ait değeri getirir.
        :param key: Anahtar adı
        :return: Kaydedilmiş değer (bulunamazsa None döner)
        """
        client = await self.get_client()
        return await client.get(name=key)

    async def delete_value(self, key: str) -> None:
        """
        Belirtilen anahtar ve değerini siler.
        :param key: Anahtar adı
        """
        client = await self.get_client()
        await client.delete(key)

    async def close(self) -> None:
        """Redis bağlantısını kapatır."""
        async with self._lock:
            if self._client and not self._client.closed:
                await self._client.close()
                self._client = None

    @classmethod
    async def get_instance(cls) -> "RedisService":
        """Singleton instance döndürür."""
        if not hasattr(cls, "_instance"):
            cls._instance = cls()
        return cls._instance